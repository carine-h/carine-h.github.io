---
title: "Blog1"
author: "Carine Hajjar"
date: "9/13/2020"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(ggplot2)
library(usmap)
library(rstanarm)
library(gt)
library(broom.mixed)
library(gtsummary)
```

```{r}
## read
popvote_df <- read_csv("popvote_1948-2016.csv")

## subset
popvote_df %>% 
  filter(year == 2016) %>% 
  select(party, candidate, pv2p)

#pv_tx_gather <- pv_tx%>%
 # gather(key = "party", value = "pv", R_pv2p, D_pv2p)%>%
  #arrange(year)


## format
(popvote_wide_df <- popvote_df %>%
  select(year, party, pv2p) %>%
  spread(party, pv2p))

## modify
(popvote_wide_df <- popvote_wide_df %>% 
  mutate(winner = case_when(democrat > republican ~ "D",
                            TRUE ~ "R")))

## summarise
popvote_wide_df %>% 
  group_by(winner) %>%
  summarise(races = n())


rep_inc <- popvote_df %>%
filter(party == "republican")

###################################
# EXTENSION 1: regression
###################################
# incumbents have a huge advantage in winning their second term elections
#fit1 <- stan_glm(winner ~ incumbent, family = "binomial", #rep_inc, refresh = FALSE)

```

```{r}
####----------------------------------------------------------#
#### Visualize trends in national pres pop vote ####
####----------------------------------------------------------#

## example: histogram
ggplot(popvote_df, aes(x = pv2p)) + 
    geom_histogram()

## example: barplot (+ custom colors)
ggplot(popvote_df, aes(x = year, y = pv2p, fill = party)) +
    geom_bar(stat = "identity") +
    scale_fill_manual(values = c("blue", "red")) 

## example: lineplot (+ custom colors + nicer theme)
ggplot(popvote_df, aes(x = year, y = pv2p, colour = party)) +
    geom_line() +
    scale_color_manual(values = c("blue", "red")) + 
    theme_bw()

## BAD plot: 
## dark background, "too much ink", no legend, small font, 
ggplot(popvote_df, aes(x = year, y = pv2p, colour = party)) +
    geom_line(stat = "identity") + 
    theme_dark() +
    theme(legend.position = "none", axis.title = element_text(size = 5))

## GOOD plot:
## high contrast, "minimal ink", legend, detailed x-ticks, larger font
ggplot(popvote_df, aes(x = year, y = pv2p, colour = party)) +
    geom_line(stat = "identity") + 
    scale_x_continuous(breaks = seq(1948, 2016, 4)) +
    theme_minimal() +
    theme(axis.text.x = element_text(angle = 45))

## EXCELLENT plot:
## "pretty" customized theme
my_pretty_theme <- theme_bw() + 
    theme(panel.border = element_blank(),
          plot.title   = element_text(size = 15, hjust = 0.5), 
          axis.text.x  = element_text(angle = 45, hjust = 1),
          axis.text    = element_text(size = 12),
          strip.text   = element_text(size = 18),
          axis.line    = element_line(colour = "black"),
          legend.position = "top",
          legend.text = element_text(size = 12))

ggplot(popvote_df, aes(x = year, y = pv2p, colour = party)) +
    geom_line(stat = "identity") +
    scale_color_manual(values = c("blue", "red"), name = "") +
    xlab("") + ## no need to label an obvious axis
    ylab("popular vote %") +
    ggtitle("Presidential Vote Share (1948-2016)") + 
    scale_x_continuous(breaks = seq(from = 1948, to = 2016, by = 4)) +
    my_pretty_theme

## saves last displayed plot
ggsave("PV_national_historical.png", height = 4, width = 8)


```

###################################
# EXTENSION 2: Winners and Incumbency
###################################
incumbents have a huge advantage in winning their second term elections
stan_glm(winner ~ incumbent, family = "binomial", rep_inc, refresh = FALSE)
popvote_df%>% 
  filter(winner == TRUE)%>%
ggplot(aes(x = year, y = pv2p, fill = party)) +
    geom_bar(stat = "identity") +
    scale_fill_manual(values = c("blue", "red")) +
  labs(y = "Two Party Popular Vote Share", 
       x = "Year", 
       title = "Two Party Vote Share of the Winning Party")+
  theme(legend.title = element_text(size=10, 
                                      face="bold")) +
  scale_fill_discrete(name = "Party", labels = c("Democrat", "Republican"))+
  scale_fill_manual(values = c("blue", "red"))
  
  
```{r}
####----------------------------------------------------------#
#### State-by-state map of pres pop votes ####
####----------------------------------------------------------#

## read in state pop vote
pvstate_df <- read_csv("popvote_bystate_1948-2016.csv")
pvstate_df$full <- pvstate_df$state

## shapefile of states from `usmap` library
## note: `usmap` merges this internally, but other packages may not!
states_map <- usmap::us_map()
unique(states_map$abbr)

## map: GOP pv2p (`plot_usmap` is wrapper function of `ggplot`)
plot_usmap(data = pvstate_df, regions = "states", values = "R_pv2p") + 
  scale_fill_gradient(low = "white", high = "red", name = "GOP two-party voteshare") +
  theme_void()

## map: wins
pv_win_map <- pvstate_df %>%
    filter(year == 2000) %>%
    mutate(winner = ifelse(R > D, "republican", "democrat"))

plot_usmap(data = pv_win_map, regions = "states", values = "winner") +
    scale_fill_manual(values = c("blue", "red"), name = "state PV winner") +
    theme_void()

## map: win-margins
pv_margins_map <- pvstate_df %>%
    filter(year == 2000) %>%
    mutate(win_margin = (R_pv2p-D_pv2p))

plot_usmap(data = pv_margins_map, regions = "states", values = "win_margin") +
    scale_fill_gradient2(
      high = "red", 
      # mid = scales::muted("purple"), ##TODO: purple or white better?
      mid = "white",
      low = "blue", 
      breaks = c(-50,-25,0,25,50), 
      limits = c(-50,50),
      name = "win margin"
    ) +
    theme_void()

## map grid
pv_map_grid <- pvstate_df %>%
    filter(year >= 1980) %>%
    mutate(winner = ifelse(R > D, "republican", "democrat"))

plot_usmap(data = pv_map_grid, regions = "states", values = "winner", color = "white") +
    facet_wrap(facets = year ~.) + ## specify a grid by year
    scale_fill_manual(values = c("blue", "red"), name = "PV winner") +
    theme_void() +
    theme(strip.text = element_text(size = 12),
          aspect.ratio=1)

ggsave("PV_states_historical.png", height = 3, width = 8)

```


###################################
# EXTENSION 3: TEXAS state map margins
###################################

# How the vote share margin has changed in Texas overtime compared to the rest of the country 
pvstate_df %>%
plot_usmap(data = "pvstate_df", regions = "state", include = "Texas", values = "R_pv2p") + 
  facet_wrap(facets = year ~.) +
  scale_fill_gradient(low = "white", high = "red", name = "GOP two-party voteshare") +
  theme_void()

pv_margins_map_tx <- pvstate_df %>%
    filter(state == "Texas") %>%
    mutate(win_margin_tx = (R_pv2p-D_pv2p))

plot_usmap(data = pv_margins_map_tx, regions = "state", include = "Texas", values = "win_margin_tx") +
  facet_wrap(facets = year ~.) +
    scale_fill_gradient2(
      high = "red", 
      mid = "purple",
      low = "blue", 
      breaks = c(-50,-25,0,25,50), 
      limits = c(-50,50),
      name = "Win Margin"
    ) +
    theme_void()

Texas has not gone blue since 1976 (and was mostly Democratic before that) - this may be changing. 


###################################
# EXTENSION 2: TEXAS state map margins line plot
###################################

## EXCELLENT plot: SOUBHIK'S PLOT OF PV2 OT
## "pretty" customized theme
my_pretty_theme <- theme_bw() + 
    theme(panel.border = element_blank(),
          plot.title   = element_text(size = 15, hjust = 0.5), 
          axis.text.x  = element_text(angle = 45, hjust = 1),
          axis.text    = element_text(size = 12),
          strip.text   = element_text(size = 18),
          axis.line    = element_line(colour = "black"),
          legend.position = "top",
          legend.text = element_text(size = 12))

ggplot(popvote_df, aes(x = year, y = pv2p, colour = party)) +
    geom_line(stat = "identity") +
    scale_color_manual(values = c("blue", "red"), name = "") +
    xlab("") + ## no need to label an obvious axis
    ylab("Popular Vote %") +
    ggtitle("Presidential Vote Share (1948-2016)") + 
    scale_x_continuous(breaks = seq(from = 1948, to = 2016, by = 4)) +
    my_pretty_theme

## EXCELLENT plot: MY PLOT OF TX PV2 
pv_tx <- pvstate_df %>%
    filter(state == "Texas")

ggplot(pv_tx, aes(x = year, y = pv2p, colour = party)) +
    geom_line(stat = "identity") +
    scale_color_manual(values = c("blue", "red"), name = "") +
    xlab("") + ## no need to label an obvious axis
    ylab("Popular Vote %") +
    ggtitle("Presidential Vote Share (1948-2016)") + 
    scale_x_continuous(breaks = seq(from = 1948, to = 2016, by = 4)) +
    my_pretty_theme

pv_tx


```{r}
####----------------------------------------------------------#
#### Extra: FiveThirtyEight replication in ggplot2 ####
#### https://projects.fivethirtyeight.com/swing-states-2020-election/
####----------------------------------------------------------#

pvstate_df$vote_margin <- pvstate_df$R_pv2p - pvstate_df$D_pv2p

pvstate_df %>% 
  ## subset data
  filter(state %in% c("Arizona","Georgia","Texas")) %>%
  filter(year >= 2000) %>%
  ## pipe into ggplot()
  ggplot(aes(x=year, y=vote_margin, color=vote_margin)) + 
  ## specify a grid by state
  facet_wrap(. ~ state) + 
  ## add plot elements
  geom_hline(yintercept=0,color="gray") +
  geom_line(size=2) + 
  geom_point(size=6) +
  ## specify scale colors
  scale_colour_gradient(low = "blue", high = "red") +
  scale_fill_gradient(low = "blue", high = "red") +
  ## specify titles, labels
  xlab("") +
  ylab("Republican vote-share margin") + 
  ggtitle("Swing states that moved sharply to the left in 2016") +
  ## switch position of x-axis and y-axis
  coord_flip() +
  ## make x-axis (year) run from top to bottom
  scale_x_reverse(breaks=unique(pvstate_df$year)) +
  theme_minimal() + 
  theme(panel.border    = element_blank(),
        plot.title      = element_text(size = 20, hjust = 0.5, face="bold"), 
        legend.position = "none",
        axis.title      = element_text(size=18),
        axis.text.x     = element_text(angle = 45, hjust = 1),
        axis.text       = element_text(size = 18),
        strip.text      = element_text(size = 18, face = "bold"))
```


```{r BLOG POST}
## map: win-margins 2000
pv_margins_map2000 <- pvstate_df %>%
    filter(year == 2000) %>%
    mutate(win_margin = (R_pv2p-D_pv2p))

plot_usmap(data = pv_margins_map2000, regions = "states", values = "win_margin") +
    scale_fill_gradient2(
      high = "red", 
      # mid = scales::muted("purple"), ##TODO: purple or white better?
      mid = "white",
      low = "blue", 
      breaks = c(-50,-25,0,25,50), 
      limits = c(-50,50),
      name = "win margin"
    ) +
    theme_void()

## map: win-margins 2016
pv_margins_map2016 <- pvstate_df %>%
    filter(year == 2016) %>%
    mutate(win_margin = (R_pv2p-D_pv2p))

plot_usmap(data = pv_margins_map2016, regions = "states", values = "win_margin") +
    scale_fill_gradient2(
      high = "red", 
      mid = "white",
      low = "blue", 
      breaks = c(-50,-25,0,25,50), 
      limits = c(-50,50),
      name = "win margin"
    ) +
    theme_void()+
    labs(title = "Win Margin Map: 2000",
       subtitle = md("Win margin by two party popular vote")) + 
  theme(panel.background = element_rect(color = "black", fill = "grey"))+
  theme(plot.title = element_text(face = "bold"), 
        plot.subtitle = element_text(face = "italic"))

   
#################
# party winners based on popular vote 
#################
## map grid
# changed from pv to pv2
pv_map_grid <- pvstate_df %>%
    filter(year >= 1996) %>%
    mutate(winner = ifelse(R_pv2p > D_pv2p, "republican", "democrat"))

plot_usmap(data = pv_map_grid, regions = "states", values = "winner", color = "white") +
    facet_wrap(facets = year ~.) + 
    scale_fill_manual(values = c("blue", "red"), name = "Two Party Popular Vote Winner") +
    theme_void() +
    theme(strip.text = element_text(size = 12),
          aspect.ratio=1) +
theme_void()+
    labs(title = "Two Party Popular Vote: 1996-2016",
       subtitle = md("Party with larger two party popular vote")) + 
  theme(panel.background = element_rect(color = "black", fill = "grey"))+
  theme(plot.title = element_text(face = "bold"), 
        plot.subtitle = element_text(face = "italic"))

#################
# ORIGINAL: win margin map 2000-2016 
#################
pv_margins_map <- pvstate_df %>%
    filter(year >= 1996)%>%
    mutate(win_margin = (R_pv2p-D_pv2p)/(R_pv2p+D_pv2p))

plot_usmap(data = pv_margins_map, regions = "states", values = "win_margin") +
    scale_fill_gradient2(
      high = "red", 
      mid = "white",
      low = "blue", 
      breaks = c(-.50,-.25,0,.25,.50), 
      limits = c(-.50,.50),
      name = "Win Margin"
    ) +
  facet_wrap(facet = year ~.)+
  theme_void()+
    labs(title = "Win Margin Map: 1996-2016",
       subtitle = md("Win margin by two party vote")) + 
  theme(panel.background = element_rect(color = "black", fill = "grey"))+
  theme(plot.title = element_text(face = "bold"), 
        plot.subtitle = element_text(face = "italic"))

# ORIGINAL: SWING margin map 2000-2016 
pv_margins_map <- pvstate_df %>%
    group_by(state)%>%
    arrange(year)%>%
    mutate(R_total_y = (R_pv2p/(D_pv2p + R_pv2p)))%>%
    mutate(diff = R_total_y - lag(R_total_y, default = first(R_total_y)))

swing_margins <- pv_margins_map %>%
  filter(year >= 1996)

plot_usmap(data = swing_margins, regions = "states", values = "diff") +
    scale_fill_gradient2(
      high = "red", 
      mid = "white",
      low = "blue", 
      breaks = c(-.50,-.25,0,.25,.50), 
      limits = c(-.50,.50),
      name = "Swing Margin"
    ) +
  facet_wrap(facet = year ~.)+
    theme_void()+
    labs(title = "Swing Map: 2000-2016",
       subtitle = md("Measure of a state's tendency to swing from one election to the next")) + 
  theme(panel.background = element_rect(color = "black", fill = "grey"))+
  theme(plot.title = element_text(face = "bold"), 
        plot.subtitle = element_text(face = "italic"))

# ORIGINAL: SWING margin map 2016 
swing_margins <- pv_margins_map %>%
  filter(year >= 2012)

plot_usmap(data = swing_margins, regions = "states", values = "diff") +
    scale_fill_gradient2(
      high = "red", 
      # mid = scales::muted("purple"), ##TODO: purple or white better?
      mid = "white",
      low = "blue", 
      breaks = c(-.50,-.25,0,.25,.50), 
      limits = c(-.50,.50),
      name = "Swing Margin"
    ) +
  facet_wrap(facet = year ~.)+
    theme_void()+
    labs(title = "Swing Map: 2012 and 2016",
       subtitle = md("Measure of a state's tendency to swing from one election to the next")) + 
  theme(panel.background = element_rect(color = "black", fill = "grey"))+
  theme(plot.title = element_text(face = "bold"), 
        plot.subtitle = element_text(face = "italic"))
```

```{r}
x <- popvote_df%>%
  select(year, party, pv2p)%>%
  spread(party, pv2p)%>%
  mutate(overall_pv2_margin = democrat-republican)

y <- pv_margins_map%>%
  filter(state == "Texas")



ggplot()
  


```

